create table if not exists stage_pcm_dev.stage_pcm_table1 (
DATE string options ( description="System date") ,
SYS_TM string options ( description="System time"),
CREDIT_CARD_NUM string options ( description="credit card number") ,
TRAN_LOCAL_DT string options( description="Transaction locate date"), 
TRAN_LOCAL_TM string options( description="Transaction locate Time"),
CREDIT_CARD_ORG_ID string options( description="Credit Card Org ID"),
PROD_NAME string options( description="Product name"),
TRAN_MRCH_TYPE string options( description="Transaction Merchant type"),
TRAN_MRCH_ID string options( description="Transaction Merchant id"),
TRAN_MRCH_NAME string options( description="Transaction Merchant name"),
TRAN_TYPE string options( description="Transaction type"),
CREDIT_BAL_VAL string options( description="Credit balance position"),
TRAN_SYSTM_ACT_VAL string options( description="Transaction system action"),
TRAN_FINAL_ACT_VAL string options( description="Transaction final action"),
TRAN_REQUST_TYP_ID string options( description="Transaction Request type ID"),
TRAN_ACTION_DESC string options( description="Transaction action description"),
TRAN_AMT string options( description="Transaction amount"),
TRAN_DCML_NUM string options( description="Transaction number of decimals"),
TRAN_BILL_AMT string options( description="Transaction billing amount"),
TRAN_BILL_CDE string options( description="Transaction billing currency code"),
ORG_CURR_DCML_NUM string options( description="Organization currency decimal"),
TRAN_CRNCY_CDE string options( description="Transaction currency"),
TRAN_ACTN_LNG_DESC string options( description="Transaction action long description"),
TRAN_ACTION_CDE string options( description="Transaction action code"),
TRAN_POS_DATA_VAL string options( description="Transaction Point of sale data Value"),
TRAN_POS_COND_CDE string options( description="Transaction Point of sale condition code"),
CREDIT_LIMIT_AMT string options( description="Credit limit amount"),
ITRAN_CAT_CDE string options( description="Transaction category code"),
TRAN_POS_ENT_CDE string options( description="Transaction Point of sale entry codi"),
ITRAN_TUN_REQ_ID string options( description="Transaction token req ID"),
TRAN_TKN_MSG string options( description="Transaction token message type"),
TRAN_SUB_DATA string options( description="Transaction Token data"),
CREDIT_ACC_NUM string options( description="Credit account number"),
CREDIT_CRD_ID string options( description="Credit Card Holder Type"),
TRAN_PROC_CODE string options( description="Processing code")  ;




CREATE TABLE
`pcm_cards_history.pcm_cards_history_table `( SYS_DT DATE OPTIONS(DESCRIPTION="SYSTEM DATE"),
SYS_TM TIME OPTIONS(DESCRIPTION="SYSTEM DATE"),
CREDIT_CARD_NUM INT64 NOT NULL OPTIONS(DESCRIPTION="CREDIT CARD NUMBER"),
TRAN_LOCAL_DT DATE OPTIONS(DESCRIPTION="TRANSACTION LOCATE DATE"),
TRAN_LOCAL_TM TIME OPTIONS(DESCRIPTION="TRANSACTION LOCATE TIME"),
CREDIT_CARD_ORG_ID INT64 OPTIONS(DESCRIPTION="CREDIT CARD ORG ID"),
PROD_NAME STRING OPTIONS(DESCRIPTION="PRODUCT NAME"),
TRAN_MRCH_TYPE INT64 OPTIONS(DESCRIPTION="TRANSACTION MERCHANT TYPE"),
TRAN_MRCH_ID STRING OPTIONS(DESCRIPTION="TRANSACTION MERCHANT ID"),
TRAN_MRCH_NAME STRING OPTIONS(DESCRIPTION="TRANSACTION MERCHANT NAME"),
TRAN_TYPE INT64 OPTIONS(DESCRIPTION="TRANSACTION TYPE"),
CREDIT_BAL_VAL INT64 OPTIONS(DESCRIPTION="CREDIT BALANCE POSITION"),
TRAN_SYSTM_ACT_VAL STRING OPTIONS(DESCRIPTION="TRANSACTION SYSTEM ACTION"),
TRAN_FINAL_ACT_VAL STRING OPTIONS(DESCRIPTION="TRANSACTION FINAL ACTION"),
TRAN_REQUST_TYP_ID STRING OPTIONS(DESCRIPTION="TRANSACTION REQUEST TYPE ID"),
TRAN_ACTION_DESC STRING OPTIONS(DESCRIPTION="TRANSACTION ACTION DESCRIPTION"),
TRAN_AMT INT64 OPTIONS(DESCRIPTION="TRANSACTION AMOUNT"),
TRAN_DCML_NUM INT64 OPTIONS(DESCRIPTION="TRANSACTION NUMBER OF DECIMALS"),
TRAN_BILL_AMT INT64 OPTIONS(DESCRIPTION="TRANSACTION BILLING AMOUNT"),
TRAN_BILL_CDE INT64 OPTIONS(DESCRIPTION="ORGANIZATION CURRENCY DECIMAL"),
ORG_CURR_DCML_NUM INT64 OPTIONS(DESCRIPTION="TRANSACTION ACTION DESCRIPTION"),
TRAN_CRNCY_CDE INT64 OPTIONS(DESCRIPTION="TRANSACTION CURRENCY"),
TRAN_ACTN_LNG_DESC STRING OPTIONS(DESCRIPTION="TRANSACTION ACTION LONG DESCRIPTION"),
TRAN_ACTION_CDE INT64 OPTIONS(DESCRIPTION="TRANSACTION ACTION CODE"),
TRAN_POS_DATA_VAL STRING OPTIONS(DESCRIPTION="TRANSACTION POINT OF SALE DATA VALUE"),
TRAN_POS_COND_CDE INT64 OPTIONS(DESCRIPTION="TRANSACTION POINT OF SALE CONDITION CODE"),
CREDIT_LIMIT_AMT INT64 OPTIONS(DESCRIPTION="CREDIT LIMIT AMOUNT"),
ITRAN_CAT_CDE STRING OPTIONS(DESCRIPTION="TRANSACTION CATEGORY CODE"),
TRAN_POS_ENT_CDE INT64 OPTIONS(DESCRIPTION="TRANSACTION POINT OF SALE ENTRY CODI"),
ITRAN_TUN_REQ_ID STRING OPTIONS(DESCRIPTION="TRANSACTION TOKEN REQ ID"),
TRAN_TKN_MSG STRING OPTIONS(DESCRIPTION="TRANSACTION TOKEN MESSAGE TYPE"),
TRAN_SUB_DATA STRING OPTIONS(DESCRIPTION="TRANSACTION TOKEN DATA"),
CREDIT_ACC_NUM INT64 OPTIONS(DESCRIPTION="CREDIT ACCOUNT NUMBER"),
CREDIT_CRD_ID INT64 OPTIONS(DESCRIPTION="CREDIT CARD HOLDER TYPE"),
TRAN_PROC_CODE STRING OPTIONS(DESCRIPTION="PROCESSING CODE"),
LAST_INGESTION_TIMESTAMP TIMESTAMP OPTIONS(DESCRIPTION="PROCESSING CODE"),
PRM_LNE_OF_BUS_CDE_FILTER STRING,
CTRY_CDE_FILTER STRING,
ENTITY_CDE_FILTER STRING)
PARTITION BY SYS_DT




MERGE
`ramgcp14.pcm_cards_history.pcm_cards_history_table ` t
USING
(
SELECT
CASE
WHEN sys_dt LIKE "%/%/%" THEN PARSE_DATE('%m/%d/%Y',SYS_DT)
WHEN sys_dt LIKE "%-%-%" THEN PARSE_DATE('%m-%d-%Y',SYS_DT)
END
SYS_DT,
CAST(SYS_TM AS time) SYS_TM,
CREDIT_CARD_NUM,
CASE
WHEN tran_local_dt LIKE "%/%/%" THEN PARSE_DATE('%m/%d/%Y',tran_local_dt)
WHEN tran_local_dt LIKE "%-%-%" THEN PARSE_DATE('%m-%d-%Y',tran_local_dt)
END
tran_local_DT,
CAST(TRAN_LOCAL_TM AS time) TRAN_LOCAL_TM,
IFNULL(CAST(CREDIT_CARD_ORG_ID AS int64),0) CREDIT_CARD_ORG_ID,
PROD_NAME,
IFNULL(CAST(TRAN_MRCH_TYPE AS int64),0) TRAN_MRCH_TYPE,
TRAN_MRCH_ID,
TRAN_MRCH_NAME,
IFNULL(CAST(TRAN_TYPE AS int64),0) TRAN_TYPE,
IFNULL(CAST(CREDIT_BAL_VAL AS int64),0) CREDIT_BAL_VAL,
TRAN_SYSTM_ACT_VAL,
TRAN_FINAL_ACT_VAL,
TRAN_REQUST_TYP_ID,
TRAN_ACTION_DESC,
IFNULL(CAST(TRAN_AMT AS int64),0)TRAN_AMT,
IFNULL(CAST(TRAN_DCML_NUM AS int64),0) TRAN_DCML_NUM,
IFNULL(CAST(TRAN_BILL_AMT AS int64),0) TRAN_BILL_AMT,
IFNULL(CAST(TRAN_BILL_CDE AS int64),0) TRAN_BILL_CDE,
IFNULL(CAST(ORG_CURR_DCML_NUM AS int64),0) ORG_CURR_DCML_NUM,
IFNULL(CAST(TRAN_CRNCY_CDE AS int64),0) TRAN_CRNCY_CDE,
TRAN_ACTN_LNG_DESC,
IFNULL(CAST(TRAN_ACTION_CDE AS int64),0) TRAN_ACTION_CDE,
TRAN_POS_DATA_VAL,
IFNULL(CAST(TRAN_POS_COND_CDE AS int64),0) TRAN_POS_COND_CDE,
IFNULL(CAST(CREDIT_LIMIT_AMT AS int64),0) CREDIT_LIMIT_AMT,
ITRAN_CAT_CDE,
IFNULL(CAST(TRAN_POS_ENT_CDE AS int64),0) TRAN_POS_ENT_CDE,
ITRAN_TUN_REQ_ID,
TRAN_TKN_MSG,
TRAN_SUB_DATA,
CREDIT_ACC_NUM,
IFNULL(CAST(CREDIT_CRD_ID AS int64),0) CREDIT_CRD_ID,
TRAN_PROC_CODE,
CURRENT_TIMESTAMP() AS LAST_INGESTION_TIMESTAMP,
"RBI" PRM_LNE_OF_BUS_CDE_FILTER,
CASE
WHEN CREDIT_CARD_ORG_ID LIKE '0' THEN 'SBI'
WHEN CREDIT_CARD_ORG_ID LIKE '100' THEN 'ICICI'
WHEN CREDIT_CARD_ORG_ID LIKE '400' THEN 'HDFC'
WHEN CREDIT_CARD_ORG_ID LIKE '900' THEN 'KOTAK'
END
AS CTRY_CDE_FILTER,
"VISA" ENTITY_CDE_FILTER
FROM
`ramgcp14.stage_pcm_dev.stage_pcm_table`) s
ON
t.CREDIT_CARD_NUM=s.CREDIT_CARD_NUM
WHEN NOT MATCHED
THEN
INSERT
VALUES
(SYS_DT,
SYS_TM,
CREDIT_CARD_NUM,
TRAN_LOCAL_DT,
TRAN_LOCAL_TM,
CREDIT_CARD_ORG_ID,
PROD_NAME,
TRAN_MRCH_TYPE,
TRAN_MRCH_ID,
TRAN_MRCH_NAME,
TRAN_TYPE,
CREDIT_BAL_VAL,
TRAN_SYSTM_ACT_VAL,
TRAN_FINAL_ACT_VAL,
TRAN_REQUST_TYP_ID,
TRAN_ACTION_DESC,
TRAN_AMT,
TRAN_DCML_NUM,
TRAN_BILL_AMT,
TRAN_BILL_CDE,
ORG_CURR_DCML_NUM,
TRAN_CRNCY_CDE,
TRAN_ACTN_LNG_DESC,
TRAN_ACTION_CDE,
TRAN_POS_DATA_VAL,
TRAN_POS_COND_CDE,
CREDIT_LIMIT_AMT,
ITRAN_CAT_CDE,
TRAN_POS_ENT_CDE,
ITRAN_TUN_REQ_ID,
TRAN_TKN_MSG,
TRAN_SUB_DATA,
CREDIT_ACC_NUM,
CREDIT_CRD_ID,
TRAN_PROC_CODE,
LAST_INGESTION_TIMESTAMP,
PRM_LNE_OF_BUS_CDE_FILTER,
CTRY_CDE_FILTER,
ENTITY_CDE_FILTER
);


